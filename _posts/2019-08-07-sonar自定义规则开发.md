---
layout: post
title: "sonarè‡ªå®šä¹‰è§„åˆ™å¼€å‘ï¼ˆå®˜æ–¹ç¤ºä¾‹ï¼‰"
date: 2019-08-07 10:00:00
image: 'https://res.cloudinary.com/dm7h7e8xj/image/upload/c_fill,h_399,w_760/v1501268554/sunrise_ttb9nk.jpg'
description: sonarè‡ªå®šä¹‰è§„åˆ™å¼€å‘.
category: 'sonar'
tags:
- sonar
twitter_text: sonarè‡ªå®šä¹‰è§„åˆ™å¼€å‘å®˜æ–¹æ•™ç¨‹ã€‚
introduction: sonarè‡ªå®šä¹‰è§„åˆ™å¼€å‘å®˜æ–¹æ•™ç¨‹ï¼Œç”±æœ‰é“ç¿»è¯‘å·¥å…·ç¿»è¯‘ã€‚
---


https://github.com/SonarSource/sonar-java/blob/master/docs/CUSTOM_RULES_101.md

ç¼–å†™è‡ªå®šä¹‰Javaè§„åˆ™101
æ‚¨æ­£åœ¨ä½¿ç”¨SonarQubeåŠå…¶Javaåˆ†æå™¨æ¥åˆ†ææ‚¨çš„é¡¹ç›®ï¼Œä½†æ˜¯æ²¡æœ‰è§„åˆ™å…è®¸æ‚¨é’ˆå¯¹å…¬å¸çš„æŸäº›ç‰¹å®šéœ€æ±‚è¿›è¡Œåˆ†æå—?ç„¶åï¼Œæ‚¨çš„é€»è¾‘é€‰æ‹©å¯èƒ½æ˜¯å®ç°æ‚¨è‡ªå·±çš„ä¸€ç»„è‡ªå®šä¹‰Javaè§„åˆ™ã€‚

æœ¬æ–‡æ¡£ä»‹ç»äº†SonarQube Javaåˆ†æå™¨çš„è‡ªå®šä¹‰è§„åˆ™ç¼–å†™ã€‚å®ƒå°†æ¶µç›–ç†è§£å’Œå¼€å‘æœ‰æ•ˆè§„åˆ™æ‰€éœ€çš„æ‰€æœ‰é™æ€åˆ†æçš„ä¸»è¦æ¦‚å¿µï¼Œå¹¶ä¾èµ–äºSonarQube Javaæ’ä»¶æä¾›çš„APIã€‚

æ–°æ‰‹å…¥é—¨
æ‚¨å°†è¦å¼€å‘çš„è§„åˆ™å°†ä½¿ç”¨ä¸€ä¸ªä¸“ç”¨çš„è‡ªå®šä¹‰æ’ä»¶æ¥äº¤ä»˜ï¼Œè¯¥æ’ä»¶ä¾èµ–äºSonarQube Java Plugin APIã€‚ä¸ºäº†æœ‰æ•ˆåœ°å¼€å§‹å·¥ä½œï¼Œæˆ‘ä»¬æä¾›äº†ä¸€ä¸ªç©ºçš„æ¨¡æ¿mavené¡¹ç›®ï¼Œæ‚¨å°†åœ¨å­¦ä¹ æœ¬æ•™ç¨‹æ—¶å¡«å……è¯¥é¡¹ç›®ã€‚
ä»ä»¥ä¸‹é“¾æ¥è·å–æ¨¡ç‰ˆé¡¹ç›®å¹¶å¯¼å…¥åˆ°ä½ çš„IDEï¼šhttps://github.com/SonarSource/sonar-custom-rules-examples/tree/master/java-custom-rules
è¯¥é¡¹ç›®å·²ç»åŒ…å«è‡ªå®šä¹‰è§„åˆ™ã€‚æˆ‘ä»¬çš„ç›®æ ‡æ˜¯æ·»åŠ ä¸€ä¸ªé¢å¤–çš„è§„åˆ™!

å…ˆçœ‹POMæ–‡ä»¶
å®šåˆ¶æ’ä»¶æ˜¯Mavené¡¹ç›®ï¼Œåœ¨æ·±å…¥ç ”ç©¶ä»£ç ä¹‹å‰ï¼Œä¸€å®šè¦æ³¨æ„ä¸å³å°†å‘å¸ƒçš„å®šåˆ¶æ’ä»¶çš„é…ç½®ç›¸å…³çš„å‡ è¡Œä»£ç ã€‚
åœ¨ä¸‹é¢çš„ä»£ç ç‰‡æ®µä¸­ï¼Œæ³¨æ„é€šè¿‡(<sonar.version>)å±æ€§æä¾›çš„æ’ä»¶APIç‰ˆæœ¬ã€‚å®ƒä¸æ‚¨çš„æ’ä»¶å°†æ”¯æŒçš„SonarQubeçš„æœ€å°ç‰ˆæœ¬æœ‰å…³ï¼Œå¹¶ä¸”é€šå¸¸ä¸æ‚¨å…¬å¸çš„SonarQubeå®ä¾‹ä¿æŒä¸€è‡´ã€‚åœ¨è¿™ä¸ªæ¨¡æ¿ä¸­ï¼Œæˆ‘ä»¬ä¾èµ–äº7.7ç‰ˆæœ¬(LTSç‰ˆæœ¬æ˜¯6.7ï¼Œä½†æ˜¯åœ¨æ‰“åŒ…æ’ä»¶æ—¶ä¿è¯äº†ä¸æœ€æ–°ç‰ˆæœ¬çš„å…¼å®¹æ€§)ã€‚æ³¨æ„ï¼Œæœ€æ–°å‘å¸ƒçš„Java Analyzerç‰ˆæœ¬æ€»æ˜¯ä¸SonarQubeçš„å½“å‰LTSç‰ˆæœ¬å…¼å®¹ã€‚
å±æ€§< java.plugin.version>æ˜¯åœ¨SonarQubeå®ä¾‹ä¸­è¿è¡Œå®šåˆ¶æ’ä»¶æ‰€éœ€çš„Java åˆ†æå™¨çš„æœ€å°ç‰ˆæœ¬ã€‚å› æ­¤ï¼Œç”±äºæˆ‘ä»¬å°†ä¾èµ–äºJavaæ’ä»¶çš„5.12.1.17771ç‰ˆæœ¬ï¼Œæ‰€ä»¥å°†ä½¿ç”¨å®šåˆ¶æ’ä»¶çš„SonarQubeå®ä¾‹ä¹Ÿéœ€è¦Javaæ’ä»¶çš„5.12.1.17771ç‰ˆæœ¬ã€‚
ç°åœ¨ï¼Œä¸è¦ä¿®æ”¹è¿™ä¸¤ä¸ªå±æ€§ã€‚
å…¶ä»–å±æ€§å¦‚<groupId>ï¼Œ <artifactId>ï¼Œ <version>ï¼Œ <name>ï¼Œ <description>å¯ä»¥è‡ªç”±ä¿®æ”¹ã€‚
<groupId>org.sonar.samples</groupId><artifactId>java-custom-rules</artifactId><version>1.0-SNAPSHOT</version><packaging>sonar-plugin</packaging> <properties>  <sonar.version>7.7</sonar.version>  <java.plugin.version>5.12.1.17771</java.plugin.version></properties><name>Java Custom Rules - Template</name>
åœ¨ä¸‹é¢çš„ä»£ç ç‰‡æ®µä¸­ï¼Œéœ€è¦å…³æ³¨çš„æ˜¯ï¼Œæ’ä»¶çš„å…¥å£é€šè¿‡sonar-packaging-mavenæ’ä»¶çš„é…ç½®ä¸­çš„<pluginClass>æ ‡ç­¾æ¥æä¾›ï¼Œä½¿ç”¨ä»¥ä¸‹é™å®šå¥½çš„javaç±»åMyJavaRulesPluginã€‚å¦‚æœé‡æ„ä»£ç ã€é‡å‘½åæˆ–ç§»åŠ¨æ‰©å±•org.sonar.api.SonarPluginçš„ç±»ï¼Œä½ å¿…é¡»æ”¹å˜è¿™ä¸ªé…ç½®ã€‚<sonarQubeMinVersion>æ˜¯ä¿è¯äº†ä¸LTS 6.7çš„å…¼å®¹æ€§çš„å±æ€§ã€‚
<plugin>  <groupId>org.sonarsource.sonar-packaging-maven-plugin</groupId>  <artifactId>sonar-packaging-maven-plugin</artifactId>  <version>1.17</version>  <extensions>true</extensions>  <configuration>    <pluginKey>java-custom</pluginKey>    <pluginName>Java Custom Rules</pluginName>    <pluginClass>org.sonar.samples.java.MyJavaRulesPlugin</pluginClass>    <sonarLintSupported>true</sonarLintSupported>    <sonarQubeMinVersion>6.7</sonarQubeMinVersion> <!-- allows to depend on API 7.x but still run on LTS 6.7 -->  </configuration></plugin>

ç¼–å†™ä¸€ä¸ªè§„åˆ™
åœ¨æœ¬èŠ‚ä¸­ï¼Œæˆ‘ä»¬å°†ä»å¤´ç¼–å†™ä¸€ä¸ªè‡ªå®šä¹‰è§„åˆ™ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æµ‹è¯•é©±åŠ¨å¼€å‘(TDD)æ–¹æ³•ï¼Œé¦–å…ˆç¼–å†™ä¸€äº›æµ‹è¯•ç”¨ä¾‹ï¼Œç„¶åå®ç°ä¸€ä¸ªè§£å†³æ–¹æ¡ˆã€‚
ä¸‰ä¸ªæ–‡ä»¶æ„æˆä¸€ä¸ªè§„åˆ™
å½“æ‰§è¡Œè§„åˆ™æ—¶ï¼Œæ€»æ˜¯æœ‰è‡³å°‘3ä¸ªä¸åŒçš„æ–‡ä»¶è¦åˆ›å»º:
1ã€ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶ï¼Œå…¶ä¸­åŒ…å«ç”¨äºæµ‹è¯•è§„åˆ™çš„è¾“å…¥æ•°æ®çš„Javaä»£ç 
2ã€ä¸€ä¸ªæµ‹è¯•ç±»ï¼Œå®ƒåŒ…å«è§„åˆ™çš„å•å…ƒæµ‹è¯•
3ã€è§„åˆ™ç±»ï¼Œå…¶ä¸­åŒ…å«è§„åˆ™çš„å®ç°ã€‚
è¦åˆ›å»ºæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªè‡ªå®šä¹‰è§„åˆ™(é€šå¸¸ç§°ä¸ºâ€œcheckâ€)ï¼Œè®©æˆ‘ä»¬ä»åœ¨æ¨¡æ¿é¡¹ç›®ä¸­åˆ›å»ºè¿™3ä¸ªæ–‡ä»¶å¼€å§‹ï¼Œå¦‚ä¸‹æ‰€è¿°:
1ã€åœ¨æ–‡ä»¶å¤¹/src/test/filesä¸­ï¼Œåˆ›å»ºä¸€ä¸ªåä¸ºMyFirstCustomCheck.javaçš„æ–°ç©ºæ–‡ä»¶ï¼Œç„¶åå¤åˆ¶ç²˜è´´ä»¥ä¸‹ä»£ç ç‰‡æ®µçš„å†…å®¹ã€‚
class MyClass {}
2ã€åœ¨/src/test/java ç›®å½•ä¸‹çš„org.sonar.samples.java.checks åŒ…ä¸­ï¼Œåˆ›å»ºä¸ªæ–°çš„æµ‹è¯•ç±»ï¼Œå«åšMyFirstCustomCheckTest å¹¶å¤åˆ¶ç²˜è´´ä»¥ä¸‹ä»£ç ç‰‡çš„å†…å®¹ï¼š
package org.sonar.samples.java.checks; import org.junit.Test; public class MyFirstCustomCheckTest {   @Test  public void test() {  } }
3ã€åœ¨/src/main/java ç›®å½•ä¸‹çš„org.sonar.samples.java.checksåŒ…å†…ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ç±»MyFirstCustomCheck ç»§æ‰¿ Java Plugin APIæä¾›çš„org.sonar.plugins.java.api.IssuableSubscriptionVisitor ç±»ã€‚ç„¶åï¼Œç”¨ä¸‹é¢ä»£ç ç‰‡æ®µä¸­çš„å†…å®¹æ›¿æ¢nodesToVisit()æ–¹æ³•çš„å†…å®¹ã€‚è¯¥æ–‡ä»¶å°†åœ¨å¤„ç†è§„åˆ™çš„å®ç°æ—¶è¿›è¡Œæè¿°ï¼
package org.sonar.samples.java.checks; import org.sonar.plugins.java.api.IssuableSubscriptionVisitor;import org.sonar.plugins.java.api.tree.Tree.Kind;import java.util.Collections;import java.util.List; @Rule(key = "MyFirstCustomRule")public class MyFirstCustomCheck extends IssuableSubscriptionVisitor {   @Override  public List<Kind> nodesToVisit() {    return Collections.emptyList();  } }
ï¼Ÿæ›´å¤šçš„æ–‡ä»¶...
å¦‚æœä¸Šé¢æè¿°çš„3ä¸ªæ–‡ä»¶æ€»æ˜¯è§„åˆ™ç¼–å†™çš„åŸºç¡€ï¼Œé‚£ä¹ˆåœ¨æŸäº›æƒ…å†µä¸‹å¯èƒ½éœ€è¦é¢å¤–çš„æ–‡ä»¶ã€‚ä¾‹å¦‚ï¼Œå½“ä¸€ä¸ªè§„åˆ™ä½¿ç”¨å‚æ•°æ—¶ï¼Œæˆ–è€…å¦‚æœå®ƒçš„è¡Œä¸ºä¾èµ–äºæ£€æµ‹åˆ°çš„javaç‰ˆæœ¬ï¼Œé‚£ä¹ˆå¯èƒ½éœ€è¦å¤šä¸ªæµ‹è¯•æ–‡ä»¶ã€‚è¿˜å¯ä»¥ä½¿ç”¨å¤–éƒ¨æ–‡ä»¶æ¥æè¿°è§„åˆ™å…ƒæ•°æ®ï¼Œæ¯”å¦‚htmlæ ¼å¼çš„æè¿°ã€‚è¿™ç§æƒ…å†µå°†åœ¨æœ¬æ–‡æ¡£çš„å…¶ä»–ä¸»é¢˜ä¸­æè¿°ã€‚
ä¸€äº›æ­£ç¡®çš„è§„èŒƒ
å½“ç„¶ï¼Œåœ¨è¿›ä¸€æ­¥è®¨è®ºä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦ä¸€ä¸ªè§„åˆ™è •åŠ¨çš„å…³é”®å…ƒç´ ï¼Œä¸€ä¸ªè§„èŒƒ!ä¸ºäº†ç»ƒä¹ çš„æ–¹ä¾¿ï¼Œè®©æˆ‘ä»¬è€ƒè™‘ä»¥ä¸‹æ¥è‡ªä¸€ä½è‘—åå¤§å¸ˆçš„åè¨€ä½œä¸ºæˆ‘ä»¬è‡ªå®šä¹‰è§„åˆ™çš„è§„èŒƒï¼Œå› ä¸ºå®ƒå½“ç„¶æ˜¯ç»å¯¹æ­£ç¡®å’Œæ— å¯äº‰è®®çš„ã€‚
Gandalf - Why Program When Magic Rulez (WPWMR, p.42)â€œFor a method having a single parameter, the types of its return value and its parameter should never be the same.â€
ä¸€ä¸ªæµ‹è¯•æ–‡ä»¶æ¥ç®¡ç†å®ƒä»¬
å› ä¸ºæˆ‘ä»¬é€‰æ‹©äº†TDDæ–¹æ³•ï¼Œæ‰€ä»¥è¦åšçš„ç¬¬ä¸€ä»¶äº‹å°±æ˜¯ç¼–å†™è§„åˆ™ç›®æ ‡ä»£ç çš„ç¤ºä¾‹ã€‚åœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œæˆ‘ä»¬è€ƒè™‘äº†æˆ‘ä»¬çš„è§„åˆ™åœ¨åˆ†æè¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°çš„è®¸å¤šæƒ…å†µï¼Œå¹¶æ ‡è®°äº†éœ€è¦æˆ‘ä»¬çš„å®ç°æ¥å¼•å‘é—®é¢˜çš„è¡Œã€‚è¦ä½¿ç”¨çš„æ ‡å¿—æ˜¯åœ¨åº”è¯¥å¼•å‘é—®é¢˜çš„ä»£ç è¡Œä¸Šçš„ä¸€ä¸ªç®€å• çš„//Nocompliant å°¾éšæ³¨é‡Šã€‚ä¸ºä»€ä¹ˆä¸åˆæ ¼?å› ä¸ºæ ‡è®°çš„è¡Œä¸ç¬¦åˆè§„åˆ™ã€‚
è¦†ç›–æ‰€æœ‰å¯èƒ½çš„æƒ…å†µå¹¶ä¸æ˜¯å¿…éœ€çš„ï¼Œè¿™ä¸ªæ–‡ä»¶çš„ç›®æ ‡æ˜¯è¦†ç›–åˆ†æè¿‡ç¨‹ä¸­å¯èƒ½é‡åˆ°çš„æ‰€æœ‰æƒ…å†µï¼Œä½†ä¹ŸæŠ½è±¡å‡ºä¸ç›¸å…³çš„ç»†èŠ‚ã€‚ä¾‹å¦‚ï¼Œåœ¨æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªè§„åˆ™ä¸Šä¸‹æ–‡ä¸­ï¼Œæ–¹æ³•çš„åç§°ã€å®ƒçš„ä¸»ä½“çš„å†…å®¹ä»¥åŠæ–¹æ³•çš„æ‰€æœ‰è€…æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œæ— è®ºæ˜¯æŠ½è±¡ç±»ã€å…·ä½“ç±»è¿˜æ˜¯æ¥å£ã€‚æ³¨æ„ï¼Œè¿™ä¸ªç¤ºä¾‹æ–‡ä»¶ä¸éœ€è¦å¯ç¼–è¯‘ï¼Œä½†æ˜¯åº”è¯¥åœ¨ç»“æ„ä¸Šæ­£ç¡®ã€‚
åœ¨å‰é¢åˆ›å»ºçš„æµ‹è¯•æ–‡ä»¶MyFirstCustomCheck.javaä¸­ï¼Œå¤åˆ¶ç²˜è´´ä»¥ä¸‹ä»£ç :
class MyClass {  MyClass(MyClass mc) { }    int     foo1() { return 0; }  void    foo2(int value) { }  int     foo3(int value) { return 0; } // Noncompliant  Object  foo4(int value) { return null; }  MyClass foo5(MyClass value) {return null; } // Noncompliant    int     foo6(int value, String name) { return 0; }  int     foo7(int ... values) { return 0;}}
æµ‹è¯•æ–‡ä»¶ç°åœ¨åŒ…å«ä»¥ä¸‹æµ‹è¯•ç”¨ä¾‹:
1ã€ç¬¬2è¡Œï¼šæ„é€ å‡½æ•°ï¼Œç”¨äºåŒºåˆ†å¤§å°å†™å’Œæ–¹æ³•;
2ã€ç¬¬4è¡Œï¼šæ²¡æœ‰å‚æ•°çš„æ–¹æ³•(foo1);
3ã€ç¬¬5è¡Œï¼šè¿”å›void (foo2)çš„æ–¹æ³•;
4ã€ç¬¬6è¡Œï¼šè¿”å›ä¸å…¶å‚æ•°(foo3)ç›¸åŒç±»å‹çš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•å°†ä¸å…¼å®¹;
5ã€ç¬¬7è¡Œï¼šå…·æœ‰å•ä¸ªå‚æ•°ä½†è¿”å›ç±»å‹ä¸åŒçš„æ–¹æ³•(foo4);
6ã€ç¬¬8è¡Œï¼šå¦ä¸€ç§æ–¹æ³•å…·æœ‰å•ä¸€å‚æ•°å’Œç›¸åŒçš„è¿”å›ç±»å‹ï¼Œä½†å…·æœ‰éåŸºæœ¬ç±»å‹(foo5)ï¼Œå› æ­¤ä¹Ÿä¸å…¼å®¹;
7ã€ç¬¬10è¡Œï¼šå…·æœ‰ä¸€ä¸ªä»¥ä¸Šå‚æ•°çš„æ–¹æ³•(foo6);
8ã€ç¬¬11è¡Œï¼šä¸€ç§å…·æœ‰å¯å˜å‚æ•°(foo7)çš„æ–¹æ³•;

ä¸€ä¸ªæµ‹è¯•ç±»ä½¿å…¶é€šè¿‡
ä¸€æ—¦æµ‹è¯•æ–‡ä»¶è¢«æ›´æ–°ï¼Œè®©æˆ‘ä»¬æ›´æ–°æˆ‘ä»¬çš„æµ‹è¯•ç±»æ¥ä½¿ç”¨å®ƒï¼Œå¹¶å°†æµ‹è¯•é“¾æ¥åˆ°æˆ‘ä»¬çš„(å°šæœªå®ç°çš„)è§„åˆ™ã€‚ä¸ºæ­¤ï¼Œå›åˆ°æˆ‘ä»¬çš„æµ‹è¯•ç±»MyFirstCustomCheckTestï¼Œå¹¶æ›´æ–°test()æ–¹æ³•ï¼Œå¦‚ä¸‹é¢çš„ä»£ç ç‰‡æ®µæ‰€ç¤º(æ‚¨å¯èƒ½å¿…é¡»å¯¼å…¥ç±»org.sonar.java.checks.verifier.JavaCheckVerifier):
  @Test  public void test() {    JavaCheckVerifier.verify("src/test/files/MyFirstCustomCheck.java", new MyFirstCustomCheck());  }
æ‚¨å¯èƒ½å·²ç»æ³¨æ„åˆ°ï¼Œè¿™ä¸ªæµ‹è¯•ç±»åŒ…å«ä¸€ä¸ªæµ‹è¯•ï¼Œå…¶ç›®çš„æ˜¯éªŒè¯æˆ‘ä»¬è¦å®ç°çš„è§„åˆ™çš„è¡Œä¸ºã€‚ä¸ºæ­¤ï¼Œå®ƒä¾èµ–äºJavaæ’ä»¶è§„åˆ™æµ‹è¯•APIæä¾›çš„JavaCheckVerifierç±»çš„ä½¿ç”¨ã€‚è¿™ä¸ªJavaCheckVerifierç±»æä¾›äº†éªŒè¯è§„åˆ™å®ç°çš„æœ‰ç”¨æ–¹æ³•ï¼Œå…è®¸æˆ‘ä»¬å®Œå…¨æŠ½è±¡ä¸åˆ†æå™¨åˆå§‹åŒ–ç›¸å…³çš„æ‰€æœ‰æœºåˆ¶ã€‚è¯·æ³¨æ„ï¼Œåœ¨éªŒè¯è§„åˆ™æ—¶ï¼Œverifierå°†æ”¶é›†æ ‡è®°ä¸ºä¸å…¼å®¹çš„è¡Œï¼Œå¹¶éªŒè¯è§„åˆ™æ˜¯å¦ä¼šå¼•å‘é¢„æœŸçš„é—®é¢˜ï¼Œå¹¶ä¸”åªä¼šå¼•å‘è¿™äº›é—®é¢˜ã€‚
ç°åœ¨ï¼Œè®©æˆ‘ä»¬ç»§ç»­TDDçš„ä¸‹ä¸€æ­¥:è®©æµ‹è¯•å¤±è´¥!
ä¸ºæ­¤ï¼Œåªéœ€ä½¿ç”¨JUnitä»æµ‹è¯•æ–‡ä»¶ä¸­æ‰§è¡Œæµ‹è¯•ã€‚æµ‹è¯•åº”è¯¥å¤±è´¥ï¼Œé”™è¯¯æ¶ˆæ¯â€œAt least one issue expectedâ€ï¼Œå¦‚ä¸‹é¢çš„ä»£ç ç‰‡æ®µæ‰€ç¤ºã€‚å› ä¸ºæˆ‘ä»¬çš„æ£€æŸ¥è¿˜æ²¡æœ‰å®ç°ï¼Œæ‰€ä»¥è¿˜ä¸èƒ½æå‡ºä»»ä½•é—®é¢˜ï¼Œæ‰€ä»¥è¿™æ˜¯é¢„æœŸçš„è¡Œä¸ºã€‚
java.lang.IllegalStateException: At least one issue expected    at com.google.common.base.Preconditions.checkState(Preconditions.java:145)    at org.sonar.java.checks.verifier.CheckVerifier.assertMultipleIssue(CheckVerifier.java:166)    at org.sonar.java.checks.verifier.CheckVerifier.checkIssues(CheckVerifier.java:161)    at org.sonar.java.checks.verifier.JavaCheckVerifier.scanFile(JavaCheckVerifier.java:237)    at org.sonar.java.checks.verifier.JavaCheckVerifier.scanFile(JavaCheckVerifier.java:220)    at org.sonar.java.checks.verifier.JavaCheckVerifier.scanFile(JavaCheckVerifier.java:216)    at org.sonar.java.checks.verifier.JavaCheckVerifier.verify(JavaCheckVerifier.java:99)    at org.sonar.template.java.checks.MyFirstCustomCheckTest.test(MyFirstCustomCheckTest.java:10)    ...

ç¬¬ä¸€ä¸ªç‰ˆæœ¬ï¼šä½¿ç”¨è¯­æ³•ä¹¦å’ŒAPIåŸºç¡€
åœ¨å¼€å§‹å®ç°è§„åˆ™ä¹‹å‰ï¼Œæ‚¨éœ€è¦äº†è§£ä¸€äº›èƒŒæ™¯çŸ¥è¯†ã€‚
åœ¨è¿è¡Œä»»ä½•è§„åˆ™ä¹‹å‰ï¼ŒSonarQube Javaåˆ†æå™¨è§£æç»™å®šçš„Javaä»£ç æ–‡ä»¶å¹¶ç”Ÿæˆä¸€ä¸ªç­‰æ•ˆçš„æ•°æ®ç»“æ„:è¯­æ³•æ ‘ã€‚Javaè¯­è¨€çš„æ¯ä¸ªæ„é€ éƒ½å¯ä»¥ç”¨ä¸€ç§ç‰¹å®šçš„è¯­æ³•æ ‘è¡¨ç¤ºï¼Œå¹¶è¯¦ç»†æè¿°å…¶æ¯ä¸ªç‰¹æ€§ã€‚è¿™äº›ç»“æ„ä¸­çš„æ¯ä¸€ä¸ªéƒ½ä¸ç‰¹å®šçš„ç±»å‹ä»¥åŠæ˜¾å¼æè¿°å…¶æ‰€æœ‰ç‰¹æ€§çš„æ¥å£ç›¸å…³è”ã€‚ä¾‹å¦‚ï¼Œä¸æ–¹æ³•å£°æ˜ç›¸å…³è”çš„ç±»å°†æ˜¯org.sonar.plugins.java.api.tree.kind.Method åŠå…¶æ¥å£ç”±org.sonar.plugins.java.api.tree.MethodTreeå®šä¹‰ã€‚æ‰€æœ‰ç§ç±»éƒ½åˆ—åœ¨Javaæ’ä»¶çš„ç§ç±»æšä¸¾ä¸­ã€‚
åœ¨åˆ›å»ºè§„åˆ™ç±»æ—¶ï¼Œæˆ‘ä»¬é€‰æ‹©ä»APIå®ç°IssuableSubscriptionVisitorç±»ã€‚è¿™ä¸ªç±»é™¤äº†æä¾›ä¸€ç»„æœ‰ç”¨çš„æ–¹æ³•æ¥å¼•å‘é—®é¢˜å¤–ï¼Œè¿˜å®šä¹‰äº†åˆ†ææ–‡ä»¶æ—¶ä½¿ç”¨çš„ç­–ç•¥ã€‚æ­£å¦‚å®ƒçš„åç§°æ‰€å‘Šè¯‰æˆ‘ä»¬çš„ï¼Œå®ƒåŸºäºè®¢é˜…æœºåˆ¶ï¼Œå…è®¸æŒ‡å®šè§„åˆ™åº”è¯¥å¯¹å“ªç§æ ‘ä½œå‡ºååº”ã€‚è¦è¦†ç›–çš„èŠ‚ç‚¹ç±»å‹åˆ—è¡¨æ˜¯é€šè¿‡nodesToVisit()æ–¹æ³•æŒ‡å®šçš„ã€‚åœ¨å‰é¢çš„æ­¥éª¤ä¸­ï¼Œæˆ‘ä»¬ä¿®æ”¹äº†æ–¹æ³•çš„å®ç°ï¼Œä»¥è¿”å›ä¸€ä¸ªç©ºåˆ—è¡¨ï¼Œå› æ­¤ä¸è®¢é˜…è¯­æ³•æ ‘çš„ä»»ä½•èŠ‚ç‚¹ã€‚
ç°åœ¨æ˜¯æ—¶å€™å¼€å§‹æ‰§è¡Œæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªè§„åˆ™äº†!è¿”å›åˆ°MyFirstCustomCheckç±»ï¼Œå¹¶ä¿®æ”¹nodesToVisit()æ–¹æ³•è¿”å›çš„ç§ç±»åˆ—è¡¨ã€‚å› ä¸ºæˆ‘ä»¬çš„è§„åˆ™ç›®æ ‡æ˜¯æ–¹æ³•å£°æ˜ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦è®¿é—®æ–¹æ³•ã€‚ä¸ºæ­¤ï¼Œåªéœ€ç¡®ä¿è¿”å›ä¸€ä¸ªåªåŒ…å«Kindçš„å•ä¾‹åˆ—è¡¨ã€‚æ–¹æ³•ä½œä¸ºè¿”å›åˆ—è¡¨çš„å‚æ•°ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ®µæ‰€ç¤ºã€‚
@Overridepublic List<Kind> nodesToVisit() {  return Collections.singletonList(Kind.METHOD);}
ä¸€æ—¦æŒ‡å®šäº†è¦è®¿é—®çš„èŠ‚ç‚¹ï¼Œæˆ‘ä»¬å°±å¿…é¡»å®ç°è§„åˆ™åœ¨é‡åˆ°æ–¹æ³•å£°æ˜æ—¶çš„ååº”ã€‚ä¸ºæ­¤ï¼Œé‡å†™æ–¹æ³•visitNode(Tree Tree)ï¼Œè¯¥æ–¹æ³•é€šè¿‡IssuableSubscriptionVisitorç»§æ‰¿è‡ªSubscriptionVisitorã€‚
@Overridepublic void visitNode(Tree tree) {}
å› ä¸ºæˆ‘ä»¬æ³¨å†Œäº†è®¿é—®æ–¹æ³•èŠ‚ç‚¹çš„è§„åˆ™ï¼Œæ‰€ä»¥æˆ‘ä»¬çŸ¥é“æ¯æ¬¡è°ƒç”¨æ–¹æ³•æ—¶ï¼Œæ ‘å‚æ•°éƒ½æ˜¯org.sonar.plugins.java.api.tree.MethodTree(ä¸METHODç±»å‹å…³è”çš„æ¥å£æ ‘)ã€‚ä½œä¸ºç¬¬ä¸€æ­¥ï¼Œæˆ‘ä»¬å¯ä»¥å®‰å…¨åœ°å°†æ ‘ç›´æ¥è½¬æ¢ä¸ºMethodTreeï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚æ³¨æ„å¦‚æœæˆ‘ä»¬æ³¨å†Œäº†å¤šä¸ªç»“ç‚¹ç±»å‹ï¼Œåœ¨ä½¿ç”¨æ–¹æ³•Tree.is(Kind...Kind)è¿›è¡Œè½¬æ¢ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»æµ‹è¯•èŠ‚ç‚¹ç±»å‹ã€‚
@Overridepublic void visitNode(Tree tree) {  MethodTree method = (MethodTree) tree;}
ç°åœ¨ï¼Œè®©æˆ‘ä»¬é€šè¿‡æ£€æŸ¥æ–¹æ³•æ˜¯å¦åªæœ‰ä¸€ä¸ªå‚æ•°æ¥ç¼©å°è§„åˆ™çš„ç„¦ç‚¹ï¼Œå¦‚æœæ˜¯è¿™æ ·ï¼Œå°±ä¼šå¼•å‘ä¸€ä¸ªé—®é¢˜ã€‚
@Overridepublic void visitNode(Tree tree) {  MethodTree method = (MethodTree) tree;  if (method.parameters().size() == 1) {    reportIssue(method.simpleName(), "Never do that!");  }}
æ¥è‡ªIssuableSubscriptionVisitorçš„æ–¹æ³•reportIssue(Tree Tree, String message)å…è®¸ç”¨ç‰¹å®šçš„æ¶ˆæ¯æŠ¥å‘Šç»™å®šæ ‘ä¸Šçš„é—®é¢˜ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œæˆ‘ä»¬é€‰æ‹©åœ¨ä¸€ä¸ªç²¾ç¡®çš„ä½ç½®æŠ¥å‘Šé—®é¢˜ï¼Œè¯¥ä½ç½®å°†æ˜¯æ–¹æ³•çš„åç§°ã€‚
java.lang.AssertionError: Unexpected at [5, 7, 11]    at org.fest.assertions.Fail.failure(Fail.java:228)    at org.fest.assertions.Fail.fail(Fail.java:218)    at org.sonar.java.checks.verifier.CheckVerifier.assertMultipleIssue(CheckVerifier.java:175)    at org.sonar.java.checks.verifier.CheckVerifier.checkIssues(CheckVerifier.java:161)    at org.sonar.java.checks.verifier.JavaCheckVerifier.scanFile(JavaCheckVerifier.java:237)    at org.sonar.java.checks.verifier.JavaCheckVerifier.scanFile(JavaCheckVerifier.java:220)    at org.sonar.java.checks.verifier.JavaCheckVerifier.scanFile(JavaCheckVerifier.java:216)    at org.sonar.java.checks.verifier.JavaCheckVerifier.verify(JavaCheckVerifier.java:99)    at org.sonar.template.java.checks.MyFirstCustomCheckTest.test(MyFirstCustomCheckTest.java:10)    ...
å½“ç„¶ï¼Œæˆ‘ä»¬çš„æµ‹è¯•åˆå¤±è´¥äº†â€¦â€¦JavaCheckVerifieræŠ¥å‘Šè¯´ï¼Œç¬¬5ã€7å’Œ11è¡Œå¼•å‘äº†æ„æƒ³ä¸åˆ°çš„é—®é¢˜ï¼Œå¦‚ä¸Šé¢çš„å †æ ˆè·Ÿè¸ªæ‰€ç¤ºã€‚é€šè¿‡å›é¡¾æˆ‘ä»¬çš„æµ‹è¯•æ–‡ä»¶,å¾ˆå®¹æ˜“æ‰¾å‡ºæé«˜ç¬¬5è¡Œæ˜¯é”™è¯¯çš„ä¸€ä¸ªé—®é¢˜,å› ä¸ºè¯¥æ–¹æ³•çš„è¿”å›ç±»å‹æ˜¯void,ç¬¬7è¡Œæ˜¯é”™è¯¯çš„,å› ä¸ºå¯¹è±¡æ˜¯ä¸ä¸€æ ·çš„int,ç¬¬11è¡Œä¹Ÿæ˜¯é”™è¯¯çš„,å› ä¸ºå˜é‡å‚æ•°æ•°é‡çš„æ–¹æ³•ã€‚ç„¶è€Œï¼Œæ ¹æ®æˆ‘ä»¬çš„å®ç°æå‡ºè¿™äº›é—®é¢˜æ˜¯æ­£ç¡®çš„ï¼Œå› ä¸ºæˆ‘ä»¬æ²¡æœ‰æ£€æŸ¥å‚æ•°å’Œè¿”å›ç±»å‹çš„ç±»å‹ã€‚ç„¶è€Œï¼Œè¦å¤„ç†ç±»å‹ï¼Œæˆ‘ä»¬å°†éœ€è¦æ›´å¤šåœ°ä¾èµ–äºä»…ä½¿ç”¨è¯­æ³•æ ‘çŸ¥è¯†å°±å¯ä»¥å®ç°çš„åŠŸèƒ½ã€‚è¿™ä¸€æ¬¡ï¼Œæˆ‘ä»¬å°†éœ€è¦ä½¿ç”¨è¯­ä¹‰API!
IssuableSubscriptionVisitorå’ŒBaseTreeVisitorä¸ºäº†å®ç°è¿™ä¸ªè§„åˆ™ï¼Œæˆ‘ä»¬é€‰æ‹©ä½¿ç”¨ä¸€ä¸ªIssuableSubscriptionVisitorä½œä¸ºè§„åˆ™çš„å®ç°åŸºç¡€ã€‚è¿™ä¸ªè®¿é—®è€…æä¾›äº†ä¸€ç§ç¼–å†™å¿«é€Ÿè€Œç®€å•çš„è§„åˆ™çš„ç®€å•æ–¹æ³•ï¼Œå› ä¸ºå®ƒå…è®¸æˆ‘ä»¬é€šè¿‡è®¢é˜…å°†è§„åˆ™çš„ç„¦ç‚¹ç¼©å°åˆ°è¦è®¿é—®çš„ä¸€ç»„ç»™å®šç±»å‹ã€‚ç„¶è€Œï¼Œè¿™ç§æ–¹æ³•å¹¶ä¸æ€»æ˜¯æœ€ä¼˜çš„ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œçœ‹çœ‹APIæä¾›çš„å¦ä¸€ä¸ªè®¿é—®è€…å¯èƒ½ä¼šå¾ˆæœ‰ç”¨:org.sonar.plugins.java.api.tree.BaseTreeVisitorã€‚BaseTreeVisitoråŒ…å«ä¸€ä¸ªç”¨äºæ¯ç§è¯­æ³•æ ‘çš„visit()æ–¹æ³•ï¼Œå½“å¿…é¡»å¯¹æ–‡ä»¶çš„è®¿é—®è¿›è¡Œå¾®è°ƒæ—¶ï¼Œè¿™ä¸ªæ–¹æ³•å°¤å…¶æœ‰ç”¨ã€‚åœ¨Javaæ’ä»¶ä¸­å·²ç»å®ç°çš„è§„åˆ™ä¸­ï¼Œæ‚¨å°†èƒ½å¤Ÿä½¿ç”¨ä¸¤ç§æ–¹æ³•æ‰¾åˆ°å¤šä¸ªè§„åˆ™:ä¸€ä¸ªä½œä¸ºå…¥å£ç‚¹çš„IssuableSubscriptionVisitorï¼Œé€šè¿‡ç®€å•çš„BaseTreeVisitor(s)æ¥è¯†åˆ«ä»£ç å…¶ä»–éƒ¨åˆ†ä¸­çš„æ¨¡å¼ã€‚

ç¬¬äºŒä¸ªç‰ˆæœ¬ï¼šä½¿ç”¨è¯­ä¹‰API
åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬çš„è§„åˆ™å®ç°åªä¾èµ–äºè¯­æ³•æ ‘ç›´æ¥æä¾›çš„æ•°æ®ï¼Œè¿™äº›æ•°æ®æ˜¯ç”±ä»£ç è§£æäº§ç”Ÿçš„ã€‚ä½†æ˜¯ï¼Œé’ˆå¯¹Javaçš„SonarAnalyzeræä¾›äº†æ›´å¤šå…³äºæ­£åœ¨åˆ†æçš„ä»£ç çš„ä¿¡æ¯ï¼Œå› ä¸ºå®ƒè¿˜æ„å»ºäº†ä»£ç çš„è¯­ä¹‰æ¨¡å‹ã€‚è¿™ä¸ªè¯­ä¹‰æ¨¡å‹æä¾›äº†ä¸è¢«æ“ä½œçš„æ¯ä¸ªç¬¦å·ç›¸å…³çš„ä¿¡æ¯ã€‚ä¾‹å¦‚ï¼Œå¯¹äºä¸€ä¸ªæ–¹æ³•ï¼Œè¯­ä¹‰APIå°†æä¾›æœ‰ç”¨çš„æ•°æ®ï¼Œä¾‹å¦‚æ–¹æ³•çš„æ‰€æœ‰è€…ã€å®ƒçš„ç”¨æ³•ã€å‚æ•°çš„ç±»å‹åŠå…¶è¿”å›ç±»å‹ã€å®ƒå¯èƒ½æŠ›å‡ºçš„å¼‚å¸¸ç­‰ç­‰ã€‚ä¸è¦çŠ¹è±«ç ”ç©¶APIçš„è¯­ä¹‰åŒ…ï¼Œä»¥ä¾¿äº†è§£åœ¨åˆ†ææœŸé—´æ‚¨å°†è®¿é—®ä»€ä¹ˆæ ·çš„ä¿¡æ¯!
ä½†æ˜¯ç°åœ¨ï¼Œè®©æˆ‘ä»¬å›åˆ°æˆ‘ä»¬çš„å®ç°å¹¶åˆ©ç”¨è¯­ä¹‰ã€‚
ä¸€æ—¦æˆ‘ä»¬çŸ¥é“æˆ‘ä»¬çš„æ–¹æ³•åªæœ‰ä¸€ä¸ªå‚æ•°ï¼Œå°±å¯ä»¥ä»ä½¿ç”¨MethodTreeä¸­çš„symbol()æ–¹æ³•è·å–æ–¹æ³•çš„ç¬¦å·å¼€å§‹ã€‚
@Overridepublic void visitNode(Tree tree) {  MethodTree method = (MethodTree) tree;  if (method.parameters().size() == 1) {    MethodSymbol symbol = method.symbol();    reportIssue(method.simpleName(), "Never do that!");  }}
ä»è¿™ä¸ªç¬¦å·ä¸­ï¼Œå¾ˆå®¹æ˜“æ£€ç´¢å®ƒçš„ç¬¬ä¸€ä¸ªå‚æ•°çš„ç±»å‹ï¼Œä»¥åŠè¿”å›ç±»å‹(æ‚¨å¯èƒ½å¿…é¡»å¯¼å…¥org.sonar.plugins.java.api.semantic.Symbol)ã€‚MethodSymbolå’Œorg.sonar.plugins.java.api.semantic.Type)ã€‚
@Overridepublic void visitNode(Tree tree) {  MethodTree method = (MethodTree) tree;  if (method.parameters().size() == 1) {    MethodSymbol symbol = method.symbol();    Type firstParameterType = symbol.parameterTypes().get(0);    Type returnType = symbol.returnType().type();    reportIssue(method.simpleName(), "Never do that!");  }}
ç”±äºè§„åˆ™åªåœ¨è¿™ä¸¤ç§ç±»å‹ç›¸åŒæ—¶æ‰ä¼šå¼•å‘é—®é¢˜ï¼Œæ‰€ä»¥åœ¨å¼•å‘é—®é¢˜ä¹‹å‰ï¼Œæˆ‘ä»¬åªéœ€æµ‹è¯•è¿”å›ç±»å‹æ˜¯å¦ä¸ç¬¬ä¸€ä¸ªå‚æ•°çš„ç±»å‹ç›¸åŒ(ä½¿ç”¨method is(String fullyQualifiedName)ï¼Œè¯¥å‚æ•°æ˜¯é€šè¿‡typeç±»æä¾›çš„)ã€‚
@Overridepublic void visitNode(Tree tree) {  MethodTree method = (MethodTree) tree;  if (method.parameters().size() == 1) {    MethodSymbol symbol = method.symbol();    Type firstParameterType = symbol.parameterTypes().get(0);    Type returnType = symbol.returnType().type();    if (returnType.is(firstParameterType.fullyQualifiedName())) {      reportIssue(method.simpleName(), "Never do that!");    }  }}
ç°åœ¨ï¼Œå†æ¬¡æ‰§è¡Œæµ‹è¯•ç±»ã€‚
æµ‹è¯•é€šè¿‡äº†å—?å¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆæ£€æŸ¥ä¸€ä¸‹ä½ æ˜¯å¦ä¸çŸ¥ä½•æ•…æ¼æ‰äº†ä¸€ä¸ªæ­¥éª¤ã€‚
å¦‚æœå®ƒé€šè¿‡äº†â€¦
ğŸ‰ Congratulations! ğŸŠ
æ‚¨å®ç°äº†SonarQube Javaåˆ†æå™¨çš„ç¬¬ä¸€ä¸ªè‡ªå®šä¹‰è§„åˆ™!

å¯ä»¥ä½¿ç”¨é‚£äº›å’Œä¸èƒ½ä½¿ç”¨å“ªäº›
åœ¨ç¼–å†™è‡ªå®šä¹‰Javaè§„åˆ™æ—¶ï¼Œåªèƒ½ä½¿ç”¨org.sonar.plugins.java.apiåŒ…ä¸­çš„ç±»ã€‚
å½“ä»SonarJavaæ’ä»¶ä¸­æµè§ˆç°æœ‰çš„500+è§„åˆ™æ—¶ï¼Œæ‚¨æœ‰æ—¶ä¼šæ³¨æ„åˆ°ä½¿ç”¨äº†å…¶ä»–ä¸€äº›å®ç”¨ç¨‹åºç±»ï¼Œè€Œä¸æ˜¯APIçš„ä¸€éƒ¨åˆ†ã€‚è™½ç„¶è¿™äº›ç±»æœ‰æ—¶åœ¨æ‚¨çš„ä¸Šä¸‹æ–‡ä¸­éå¸¸æœ‰ç”¨ï¼Œä½†æ˜¯è¿™äº›ç±»åœ¨è¿è¡Œæ—¶ä¸èƒ½ç”¨äºå®šåˆ¶è§„åˆ™æ’ä»¶ã€‚è¿™æ„å‘³ç€ï¼Œè™½ç„¶æ„å»ºæ’ä»¶æ—¶æ‚¨çš„å•å…ƒæµ‹è¯•ä»å°†é€šè¿‡ï¼Œä½†æ˜¯æ‚¨çš„è§„åˆ™å¾ˆå¯èƒ½åœ¨åˆ†ææ—¶å¯¼è‡´åˆ†æå´©æºƒã€‚
è¯·æ³¨æ„ï¼Œæˆ‘ä»¬æ€»æ˜¯å¯¹è®¨è®ºæŒå¼€æ”¾æ€åº¦ï¼Œæ‰€ä»¥ä¸è¦çŠ¹è±«è”ç³»æˆ‘ä»¬ï¼Œå¹¶é€šè¿‡æˆ‘ä»¬çš„ç¤¾åŒºè®ºå›å‚ä¸åˆ°çº¿ç¨‹ä¸­æ¥ï¼Œå»ºè®®ç‰¹æ€§å’ŒAPIæ”¹è¿›!

åœ¨è‡ªå®šä¹‰æ’ä»¶ä¸­æ³¨å†Œè§„åˆ™
å¥½äº†ï¼Œæ‚¨å¯èƒ½å·²ç»å¾ˆæ»¡æ„äº†ï¼Œå› ä¸ºæˆ‘ä»¬çš„ç¬¬ä¸€æ¡è§„åˆ™æ­£å¦‚é¢„æœŸçš„é‚£æ ·è¿è¡Œâ€¦â€¦ç„¶è€Œï¼Œæˆ‘ä»¬è¿˜æ²¡æœ‰çœŸæ­£å®Œæˆã€‚åœ¨å¯¹ä»»ä½•å®é™…é¡¹ç›®ä½¿ç”¨æˆ‘ä»¬çš„è§„åˆ™ä¹‹å‰ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨å®šåˆ¶æ’ä»¶ä¸­å®Œæˆå®ƒçš„åˆ›å»ºï¼Œæ–¹æ³•æ˜¯æ³¨å†Œå®ƒã€‚
è§„åˆ™å…ƒæ•°æ®
é¦–å…ˆè¦åšçš„æ˜¯ä¸ºæˆ‘ä»¬çš„è§„åˆ™æä¾›æ‰€æœ‰å…ƒæ•°æ®ï¼Œè¿™äº›å…ƒæ•°æ®å°†å…è®¸æˆ‘ä»¬åœ¨SonarQubeå¹³å°ä¸­æ­£ç¡®æ³¨å†Œå®ƒã€‚ä¸ºæ­¤ï¼Œæ·»åŠ org.sonar.check.ruleæ³¨é‡Šåˆ°MyFirstCustomCheckç±»è§„åˆ™ï¼Œå¹¶æä¾›é”®ã€åç§°ã€æè¿°å’Œå¯é€‰æ ‡è®°ï¼Œå¦‚ä¸‹é¢çš„ä»£ç ç‰‡æ®µæ‰€ç¤ºã€‚
@Rule(  key = "MyFirstCustomCheck",  name = "Return type and parameter of a method should not be the same",  description = "For a method having a single parameter, the types of its return value and its parameter should never be the same.",  priority = Priority.CRITICAL,  tags = {"bug"})public class MyFirstCustomCheck extends IssuableSubscriptionVisitor {  // ...}
è§„åˆ™æ¿€æ´»
è¦åšçš„ç¬¬äºŒä»¶äº‹æ˜¯æ¿€æ´»æ’ä»¶ä¸­çš„è§„åˆ™ã€‚ä¸ºæ­¤ï¼Œæ‰“å¼€ç±»RulesList (org.sonar.samples.java.RulesList)ã€‚åœ¨è¿™ä¸ªç±»ä¸­ï¼Œæ‚¨å°†æ³¨æ„åˆ°getJavaChecks()å’Œgetjavatestcheck()æ–¹æ³•ã€‚è¿™äº›æ–¹æ³•ç”¨äºæ³¨å†Œæˆ‘ä»¬çš„è§„åˆ™ä»¥åŠJavaæ’ä»¶çš„è§„åˆ™ã€‚æ³¨æ„ï¼Œåœ¨getJavaChecks()ä¸­æ³¨å†Œçš„è§„åˆ™åªå¯¹æºæ–‡ä»¶æ’­æ”¾ï¼Œè€Œåœ¨getjavatestcheck()ä¸­æ³¨å†Œçš„è§„åˆ™åªå¯¹æµ‹è¯•æ–‡ä»¶æ’­æ”¾ã€‚è¦æ³¨å†Œè§„åˆ™ï¼Œåªéœ€å°†è§„åˆ™ç±»æ·»åŠ åˆ°åˆ—è¡¨ç”Ÿæˆå™¨ä¸­ï¼Œå¦‚ä¸‹é¢çš„ä»£ç æ®µæ‰€ç¤º:
public static List<Class<? extends JavaCheck>> getJavaChecks() {  return Collections.unmodifiableList(Arrays.asList(      // other rules...      MyFirstCustomCheck.class    ));}
æ³¨å†Œè§„åˆ™
å› ä¸ºæ‚¨çš„è§„åˆ™ä¾èµ–äºSonarJava APIï¼Œæ‰€ä»¥è¿˜éœ€è¦å‘Šè¯‰SonarJavaçˆ¶æ’ä»¶å¿…é¡»æ£€ç´¢ä¸€äº›æ–°è§„åˆ™ã€‚å¦‚æœæ‚¨æ­£åœ¨ä½¿ç”¨æ¨¡æ¿è‡ªå®šä¹‰æ’ä»¶ä½œä¸ºæœ¬æ•™ç¨‹çš„åŸºç¡€ï¼Œé‚£ä¹ˆæ‚¨åº”è¯¥å·²ç»å®Œæˆäº†æ‰€æœ‰çš„å·¥ä½œï¼Œä½†æ˜¯è¯·éšæ„æŸ¥çœ‹è¿æ¥è¿™äº›ç‚¹çš„MyJavaFileCheckRegistrar.javaç±»ã€‚æœ€åï¼Œé€šè¿‡å°†æ³¨å†Œå™¨ç±»æ·»åŠ åˆ°æ’ä»¶å®šä¹‰ç±»(MyJavaRulesPlugin.java)ä¸­ï¼Œç¡®ä¿è¿™ä¸ªæ³¨å†Œå™¨ç±»ä¹Ÿä½œä¸ºå®šåˆ¶æ’ä»¶çš„æ‰©å±•è¢«æ­£ç¡®æ·»åŠ ã€‚
/** * Provide the "checks" (implementations of rules) classes that are going be executed during * source code analysis. * * This class is a batch extension by implementing the {@link org.sonar.plugins.java.api.CheckRegistrar} interface. */@SonarLintSidepublic class MyJavaFileCheckRegistrar implements CheckRegistrar {   /**   * Register the classes that will be used to instantiate checks during analysis.   */  @Override  public void register(RegistrarContext registrarContext) {    // Call to registerClassesForRepository to associate the classes with the correct repository key    registrarContext.registerClassesForRepository(MyJavaRulesDefinition.REPOSITORY_KEY, checkClasses(), testCheckClasses());  }    /**   * Lists all the main checks provided by the plugin   */  public static List<Class<? extends JavaCheck>> checkClasses() {    return RulesList.getJavaChecks();  }   /**   * Lists all the test checks provided by the plugin   */  public static List<Class<? extends JavaCheck>> testCheckClasses() {    return RulesList.getJavaTestChecks();  } }
æµ‹è¯•è‡ªå®šä¹‰æ’ä»¶
å…ˆå†³æ¡ä»¶åœ¨æœ¬ç« ä¸­ï¼Œæ‚¨å°†éœ€è¦SonarQubeçš„ä¸€ä¸ªæœ¬åœ°å®ä¾‹ã€‚å¦‚æœæ‚¨çš„æœºå™¨ä¸Šæ²¡æœ‰å®‰è£…SonarQubeå¹³å°ï¼Œç°åœ¨æ˜¯æ—¶å€™ä»è¿™é‡Œä¸‹è½½å®ƒçš„æœ€æ–°ç‰ˆæœ¬äº†!
è‡³æ­¤ï¼Œæˆ‘ä»¬å·²ç»å®Œæˆäº†ç¬¬ä¸€ä¸ªè‡ªå®šä¹‰è§„åˆ™çš„å®ç°ï¼Œå¹¶å°†å…¶æ³¨å†Œåˆ°è‡ªå®šä¹‰æ’ä»¶ä¸­ã€‚æœ€åä¸€ä¸ªæ­¥éª¤æ˜¯ç›´æ¥ä½¿ç”¨SonarQubeå¹³å°æµ‹è¯•å®ƒï¼Œå¹¶å°è¯•åˆ†æä¸€ä¸ªé¡¹ç›®!
é¦–å…ˆä½¿ç”¨mavenæ„å»ºé¡¹ç›®:
$ pwd/home/gandalf/workspace/java-custom-rules-template  $ mvn clean install[INFO] Scanning for projects...[INFO]                                                                        [INFO] ------------------------------------------------------------------------[INFO] Building Java Custom Rules - Template 1.0-SNAPSHOT[INFO] ------------------------------------------------------------------------  ... [INFO] ------------------------------------------------------------------------[INFO] BUILD SUCCESS[INFO] ------------------------------------------------------------------------[INFO] Total time: 4.102 s[INFO] Finished at: 2016-05-23T16:21:55+02:00[INFO] Final Memory: 25M/436M[INFO] ------------------------------------------------------------------------
ç„¶åï¼Œä»é¡¹ç›®çš„ç›®æ ‡æ–‡ä»¶å¤¹ä¸­è·å–jaræ–‡ä»¶java-custom-rules-1.0- snap .jarï¼Œå¹¶å°†å…¶ç§»åŠ¨åˆ°SonarQubeå®ä¾‹çš„extensionsæ–‡ä»¶å¤¹ä¸­ï¼Œè¯¥æ–‡ä»¶å¤¹ä½äº$SONAR_HOME/extensions/pluginsã€‚
SonarQube Javaæ’ä»¶å…¼å®¹ç‰ˆæœ¬åœ¨ç»§ç»­ä¹‹å‰ï¼Œè¯·ç¡®ä¿SonarQubeå®ä¾‹ä¸­æœ‰è¶³å¤Ÿçš„SonarQube Javaæ’ä»¶ç‰ˆæœ¬ã€‚è‡ªå®šä¹‰æ’ä»¶å¯¹Javaæ’ä»¶çš„ä¾èµ–å…³ç³»åœ¨å…¶pomä¸­å®šä¹‰ï¼Œå¦‚æœ¬æ•™ç¨‹ç¬¬ä¸€ç« æ‰€ç¤ºã€‚å¦‚æœæ‚¨æœ‰ä¸€ä¸ªæ–°çš„å®‰è£…æˆ–æ²¡æœ‰ç›¸åŒçš„ç‰ˆæœ¬ï¼Œè¯·å®‰è£…é€‚å½“ç‰ˆæœ¬çš„Javaæ’ä»¶ã€‚æœ€æ–°ç‰ˆæœ¬çš„æ’ä»¶å¯ä»¥ä»è¿™é‡Œä¸‹è½½ã€‚
ç°åœ¨ï¼Œ(é‡æ–°)å¯åŠ¨SonarQubeå®ä¾‹ï¼Œä»¥adminèº«ä»½ç™»å½•å¹¶å¯¼èˆªåˆ°Rulesé€‰é¡¹å¡ã€‚
ç„¶åï¼Œåœ¨â€œè¯­è¨€â€ä¸€èŠ‚ä¸­ï¼Œé€‰æ‹©â€œJavaâ€ï¼Œç„¶ååœ¨â€œRepositoryâ€ä¸€èŠ‚ä¸­é€‰æ‹©â€œMyCompany Custom Repositoryâ€ã€‚æ‚¨çš„è§„åˆ™ç°åœ¨åº”è¯¥æ˜¯å¯è§çš„(ä¸æ‰€æœ‰å…¶ä»–ç¤ºä¾‹è§„åˆ™ä¸€èµ·)ã€‚

ä¸€æ—¦æ¿€æ´»ï¼Œå‰©ä¸‹çš„å”¯ä¸€æ­¥éª¤æ˜¯åˆ†ææ‚¨çš„ä¸€ä¸ªé¡¹ç›®!
å½“é‡åˆ°è¿”å›ä¸å…¶å‚æ•°ç±»å‹ç›¸åŒçš„æ–¹æ³•æ—¶ï¼Œé—®é¢˜å°±ä¼šå‡ºç°ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤º:

å¦‚ä½•å®šä¹‰è§„åˆ™å‚æ•°
æ‚¨å¿…é¡»å°†@RulePropertyæ·»åŠ åˆ°è§„åˆ™ä¸­ã€‚
æ£€æŸ¥è¿™ä¸ªç¤ºä¾‹:SecurityAnnotationMandatoryRule.java
å¦‚ä½•æµ‹è¯•éœ€è¦å¤–éƒ¨äºŒè¿›åˆ¶æ–‡ä»¶çš„æºä»£ç 
åœ¨pom.xmlä¸­ï¼Œåœ¨Maven Dependency Plugin éƒ¨åˆ†å®šä¹‰å•å…ƒæµ‹è¯•è¿è¡Œæ‰€éœ€è¦çš„æ‰€æœ‰çš„jaråŒ…ï¼Œä¾‹å¦‚ï¼Œå¦‚æœå•å…ƒæµ‹è¯•ä¸­ä½¿ç”¨çš„æ ·ä¾‹ä»£ç ä¾èµ–äºSpringï¼Œåˆ™å°†å…¶æ·»åŠ åˆ°é‚£é‡Œã€‚
è§ï¼šhttps://github.com/SonarSource/sonar-custom-rules-examples/blob/master/java-custom-rules/pom.xml#L147
å¦‚ä½•æµ‹è¯•å‡†ç¡®çš„é—®é¢˜å®šä½
æ‚¨å¯ä»¥åœ¨ç»™å®šçš„è¡Œä¸Šæå‡ºé—®é¢˜ï¼Œä½†ä¹Ÿå¯ä»¥åœ¨ç‰¹å®šçš„ä»¤ç‰Œå¤„æå‡ºé—®é¢˜ã€‚å› æ­¤ï¼Œæ‚¨å¯èƒ½å¸Œæœ›åœ¨å•å…ƒæµ‹è¯•ä½¿ç”¨çš„ç¤ºä¾‹ä»£ç ä¸­æŒ‡å®šç¡®åˆ‡çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨è¿™ä¸¤åˆ—ä¹‹é—´ï¼Œæ‚¨å¸Œæœ›åœ¨å“ªé‡Œå¼•å‘é—®é¢˜ã€‚
è¿™å¯ä»¥ä½¿ç”¨// Noncompliantæ³¨é‡Šä¸­çš„ç‰¹æ®Šå…³é”®å­—sc(å¼€å§‹åˆ—)å’Œec(ç»“æŸåˆ—)æ¥å®ç°ã€‚åœ¨ä¸‹é¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬æœŸæœ›åœ¨ç¬¬27åˆ—å’Œç¬¬32åˆ—ä¹‹é—´å‡ºç°é—®é¢˜(å³æ­£å¥½åœ¨â€œOrderâ€å˜é‡ç±»å‹ä¸Š):
public String updateOrder(Order order) { // Noncompliant [[sc=27;ec=32]] {{Don't use Order here because it's an @Entity}}
å¦‚ä½•åœ¨è§„åˆ™ä¸­æµ‹è¯•æºç‰ˆæœ¬
ä»Java Plugin API 3.7(2015å¹´10æœˆ)å¼€å§‹ï¼Œç¼–å†™è‡ªå®šä¹‰è§„åˆ™æ—¶å¯ä»¥ç›´æ¥è®¿é—®Javaæºç‰ˆæœ¬ã€‚è¿™å¯ä»¥é€šè¿‡ç®€å•åœ°ä»ä¸Šä¸‹æ–‡ä¸­è°ƒç”¨getjavaversion()æ–¹æ³•æ¥å®ç°ã€‚æ³¨æ„ï¼Œè¯¥æ–¹æ³•ä»…åœ¨æœªè®¾ç½®å±æ€§æ—¶æ‰è¿”å›nullã€‚ç±»ä¼¼åœ°ï¼Œä¹Ÿå¯ä»¥å‘éªŒè¯è€…æŒ‡å®šä¸€ä¸ªJavaç‰ˆæœ¬ä½œä¸ºè¿è¡Œæ—¶æ‰§è¡Œï¼Œè°ƒç”¨æ–¹æ³•verify(String filename, JavaFileScanner check, int javaversion)ã€‚
@Betapublic interface JavaFileScannerContext {  // ...    @Nullable  Integer getJavaVersion();  }
